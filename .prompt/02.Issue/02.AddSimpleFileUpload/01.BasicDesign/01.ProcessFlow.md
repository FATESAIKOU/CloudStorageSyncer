# 檔案上傳功能處理流程設計

## 1. 整體流程概觀

```plantuml
@startuml
!theme plain

|CLI Layer|
start
:用戶執行 CLI 命令;
:解析命令參數;
note right
  - 檔案路徑
  - Storage Class
  - 其他選項
end note

|Service Layer|
:驗證輸入參數;
:檢查檔案存在性;
:載入 S3 配置;
note right
  配置優先順序:
  1. CLI 參數
  2. 環境變數
  3. 配置檔案
end note

:調用核心上傳功能;

|Core Layer|
:建立 S3 客戶端;
:執行檔案上傳;
:回傳結果;

|Service Layer|
:處理上傳結果;
:產生操作日誌;

|CLI Layer|
:顯示結果給用戶;
stop
@enduml
```

## 2. S3 配置管理流程

```plantuml
@startuml
!theme plain

start
:用戶請求設定 S3 配置;

if (指定配置項目?) then (是)
  :更新指定配置項目;
else (否)
  :顯示當前配置狀態;
endif

:驗證配置完整性;
note right
  必要項目:
  - Access Key
  - Secret Key
  - Bucket Name
  - Region (可選，預設 us-east-1)
end note

if (配置完整?) then (是)
  :測試 S3 連接;
  if (連接成功?) then (是)
    :儲存配置;
    :顯示成功訊息;
  else (否)
    :顯示錯誤訊息;
    :提供除錯建議;
  endif
else (否)
  :顯示缺少的配置項目;
endif

stop
@enduml
```

## 3. 檔案上傳詳細流程

```plantuml
@startuml
!theme plain

start
:接收上傳請求;
:驗證輸入參數;

if (檔案存在?) then (否)
  :回傳檔案不存在錯誤;
  stop
endif

if (檔案可讀取?) then (否)
  :回傳權限錯誤;
  stop
endif

:載入 S3 配置;

if (S3 配置完整?) then (否)
  :回傳配置錯誤;
  stop
endif

:建立 S3 客戶端;

if (測試 S3 連接?) then (否)
  :回傳連接錯誤;
  stop
endif

:準備上傳參數;
note right
  - Key (檔名或指定路徑)
  - Storage Class
  - Content Type (自動偵測)
  - Metadata
end note

:執行檔案上傳;

if (上傳成功?) then (是)
  :記錄上傳資訊;
  :回傳成功結果;
else (否)
  :記錄錯誤資訊;
  :回傳失敗結果;
endif

stop
@enduml
```

## 4. 錯誤處理流程

```plantuml
@startuml
!theme plain

start
:捕獲異常;

if (檔案系統錯誤?) then (是)
  :回傳檔案相關錯誤訊息;
elseif (AWS 認證錯誤?) then (是)
  :回傳認證錯誤訊息;
  :提供配置檢查建議;
elseif (網路連接錯誤?) then (是)
  :回傳網路錯誤訊息;
  :提供重試建議;
elseif (S3 服務錯誤?) then (是)
  :回傳 S3 錯誤訊息;
  :提供相應解決方案;
else (其他錯誤)
  :記錄詳細錯誤資訊;
  :回傳一般錯誤訊息;
endif

:記錄錯誤日誌;
stop
@enduml
```

## 5. CLI 命令結構設計

### 5.1 配置命令
```bash
# 設定 AWS 認證資訊
cloud-storage-syncer config set aws-access-key-id YOUR_ACCESS_KEY
cloud-storage-syncer config set aws-secret-access-key YOUR_SECRET_KEY
cloud-storage-syncer config set bucket-name YOUR_BUCKET_NAME
cloud-storage-syncer config set region us-west-2  # 可選

# 查看當前配置
cloud-storage-syncer config show
cloud-storage-syncer config list

# 測試配置
cloud-storage-syncer config test
```

### 5.2 上傳命令
```bash
# 基本上傳 (使用預設 Intelligent-Tiering)
cloud-storage-syncer upload /path/to/file.txt

# 指定 Storage Class
cloud-storage-syncer upload /path/to/file.txt --storage-class STANDARD
cloud-storage-syncer upload /path/to/file.txt --storage-class GLACIER

# 指定 S3 中的檔名
cloud-storage-syncer upload /path/to/file.txt --key my-folder/renamed-file.txt

# 批次上傳
cloud-storage-syncer upload /path/to/folder/ --recursive
```

## 6. 配置資料流程

```plantuml
@startuml
!theme plain

start
:讀取配置需求;

partition "配置來源優先順序" {
  :1. CLI 參數;
  :2. 環境變數;
  :3. 配置檔案;
  :4. 預設值;
}

:合併配置資料;
:驗證必要參數;

if (配置完整?) then (是)
  :回傳有效配置;
else (否)
  :回傳錯誤與缺少項目;
endif

stop
@enduml
```

## 7. 主要處理步驟總結

1. **輸入驗證**: 檔案路徑、參數格式、Storage Class 有效性
2. **配置載入**: 按優先順序載入 AWS 配置
3. **連接測試**: 驗證 AWS S3 可用性
4. **檔案準備**: 檢查檔案存在性、可讀性、大小
5. **上傳執行**: 執行實際的 S3 上傳操作
6. **結果處理**: 成功/失敗處理、日誌記錄、用戶回饋

## 8. 非功能性需求

- **效能**: 支援大檔案上傳 (分片上傳)
- **可靠性**: 自動重試機制
- **安全性**: 避免在日誌中記錄敏感資訊
- **用戶體驗**: 清晰的錯誤訊息和進度指示
