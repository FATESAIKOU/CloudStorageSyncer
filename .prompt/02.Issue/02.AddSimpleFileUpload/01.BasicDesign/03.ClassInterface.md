# 類別介面設計

## 1. 類別架構設計

### 1.1 整體架構概觀

```plantuml
@startuml
!theme plain

package "CLI Layer" {
  class ConfigCommands {
    +setup()
    +show()
    +test()
    +remove()
  }

  class UploadCommands {
    +file()
    +directory()
    +batch()
  }

  class MainCLI {
    +version()
    +health()
    +info()
  }
}

package "Service Layer" {
  class S3Service {
    +upload_file(request: UploadRequest): UploadResult
    +test_connection(): bool
    +get_object_info(s3_key): dict
  }

  class ConfigService {
    +load_config(): S3Config
    +save_config(config: S3Config): bool
    +config_exists(): bool
    +delete_config(): bool
  }
}

package "CoreModel (Data Models)" {
  class S3Config {
    +access_key: str
    +secret_key: str
    +bucket: str
    +region: str
    +is_valid(): bool
  }

  enum S3StorageClass {
    STANDARD
    INTELLIGENT_TIERING
    STANDARD_IA
    ONEZONE_IA
    GLACIER_IR
    GLACIER
    DEEP_ARCHIVE
  }

  class UploadRequest {
    +file_path: str
    +s3_key: str
    +storage_class: S3StorageClass
  }

  class UploadResult {
    +success: bool
    +error_message: str
    +s3_url: str
    +storage_class: str
    +success(s3_url, storage_class): UploadResult
    +error(error_message): UploadResult
  }
}

ConfigCommands --> ConfigService
UploadCommands --> S3Service
S3Service --> S3Config
S3Service --> UploadRequest
S3Service --> UploadResult
UploadRequest --> S3StorageClass

@enduml
```

## 2. CLI 指令與流程設計

### 2.1 CLI 指令清單

本系統將提供以下 CLI 指令：

1. **主要功能指令**
   - `upload` - 上傳檔案到 S3

2. **配置管理指令群組 (config)**
   - `config set` - 設定配置項目
   - `config show` - 顯示目前配置
   - `config test` - 測試 S3 連接

### 2.2 upload 指令完整流程

```mermaid
flowchart TD
    subgraph CLI["CLI Layer"]
        A[用戶執行 upload 指令] --> B{是否指定 S3 key?}
        B -->|否| C[使用檔案名稱作為 key]
        B -->|是| D[使用指定的 key]
        C --> E[建立 UploadRequest]
        D --> E
        E --> F[呼叫 S3Service.upload]

        O{上傳是否成功?} --> P[顯示成功訊息]
        O --> Q[顯示錯誤訊息]
        P --> R[指令結束]
        Q --> R
    end

    subgraph Service["S3Service Layer"]
        F --> G{檔案是否存在?}
        G -->|否| H[返回錯誤: 檔案不存在]
        G -->|是| I[載入 S3 配置]
        I --> J{配置是否完整?}
        J -->|否| K[返回錯誤: 配置不完整]
        J -->|是| L[建立 S3 客戶端]
        L --> M[執行檔案上傳到 S3]
        M --> N{上傳是否成功?}
        N -->|否| H2[返回失敗結果 + 錯誤訊息]
        N -->|是| I2[返回成功結果]
    end

    H --> O
    K --> O
    H2 --> O
    I2 --> O
```

### 2.3 config set 指令完整流程

```mermaid
flowchart TD
    subgraph CLI["CLI Layer"]
        A[用戶執行 config set 指令] --> B{配置項目是否有效?}
        B -->|否| C[顯示無效配置項目錯誤]
        B -->|是| D[載入現有配置]
        D --> E[更新指定配置值]
        E --> F[呼叫 S3Service.save_config]

        J[顯示更新成功訊息] --> K[指令結束]
        C --> K
    end

    subgraph Service["S3Service Layer"]
        F --> G[建立配置目錄]
        G --> H[轉換 S3Config 為字典格式]
        H --> I[寫入 JSON 檔案並設定權限]
        I --> I2[清除 S3 客戶端快取]
    end

    I2 --> J
```

### 2.4 config show 指令完整流程

```mermaid
flowchart TD
    subgraph CLI["CLI Layer"]
        A[用戶執行 config show 指令] --> B[呼叫 S3Service.load_config]

        F[以遮罩形式顯示敏感資訊] --> G[指令結束]
    end

    subgraph Service["S3Service Layer"]
        B --> C{配置檔案存在?}
        C -->|否| D[返回空配置物件]
        C -->|是| E[讀取並解析 JSON 檔案]
        E --> E2[建立並返回 S3Config 物件]
    end

    D --> F
    E2 --> F
```

### 2.5 config test 指令完整流程

```mermaid
flowchart TD
    subgraph CLI["CLI Layer"]
        A[用戶執行 config test 指令] --> B[呼叫 S3Service.test_connection]

        H{測試是否成功?} --> I[顯示連接成功訊息]
        H --> J[顯示連接失敗訊息]
        I --> K[指令結束]
        J --> K
    end

    subgraph Service["S3Service Layer"]
        B --> C[載入 S3 配置]
        C --> D{配置是否完整?}
        D -->|否| E[返回 false]
        D -->|是| F[建立 S3 客戶端]
        F --> G[嘗試訪問 S3 Bucket]
        G --> G2{是否成功?}
        G2 -->|是| E2[返回 true]
        G2 -->|否| E
    end

    E --> H
    E2 --> H
```

## 3. 錯誤處理策略

### 3.1 錯誤處理流程

```mermaid
flowchart TD
    A[S3 操作] --> B{操作是否成功?}
    B -->|是| C[返回成功結果]
    B -->|否| D{錯誤類型判斷}
    D -->|檔案不存在| E[返回: 檔案不存在]
    D -->|權限不足| F[返回: 檔案權限不足]
    D -->|S3 錯誤| G[返回: S3 操作失敗 + 原始錯誤]
    D -->|其他錯誤| H[返回: 操作失敗 + 錯誤訊息]

    E --> I[CLI 層顯示用戶友好錯誤]
    F --> I
    G --> I
    H --> I
    C --> J[CLI 層顯示成功訊息]
    I --> K[結束]
    J --> K
```

### 3.2 常見錯誤場景處理

- **檔案不存在** → 顯示錯誤訊息
- **配置不完整** → 提示設定配置
- **S3 操作失敗** → 顯示 boto3 原始錯誤
- **網路問題** → 顯示連接錯誤

## 4. 實作步驟

### 4.1 開發階段規劃

```mermaid
flowchart LR
    A[建立資料模型] --> B[實作 S3Service]
    B --> C[建立 CLI 命令]
    C --> D[測試基本上傳功能]
    D --> E[完善錯誤處理]

    A1[S3Config<br/>UploadRequest<br/>UploadResult<br/>S3StorageClass] -.-> A
    B1[核心業務邏輯<br/>配置管理<br/>S3 操作] -.-> B
    C1[Typer 框架<br/>命令介面] -.-> C
    D1[功能驗證<br/>錯誤測試] -.-> D
    E1[逐步改進<br/>使用者體驗] -.-> E
```

### 4.2 設計優勢

此設計清楚分離：
- **CoreModel**: 純資料結構，提供型別安全
- **Service**: 業務邏輯處理，具有清晰介面
- **CLI**: 使用者介面，委派給服務層處理

這種方法避免過度工程化，同時保持乾淨、易維護的結構，專注於核心需求：「簡單檔案上傳功能」。
