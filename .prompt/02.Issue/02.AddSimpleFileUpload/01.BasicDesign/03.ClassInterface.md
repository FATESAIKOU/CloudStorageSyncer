# Class/Method/Interface è¨­è¨ˆ

## 1. æ•´é«”æ¶æ§‹è¨­è¨ˆ

### 1.1 ä¸‰å±¤æ¶æ§‹æ¦‚è§€

```plantuml
@startuml
!theme plain

package "CLI Layer" {
  class UploadCommand {
    +upload(file_path: str, storage_class: str, key: str)
    +config_set(key: str, value: str)
    +config_show()
    +config_test()
  }
}

package "Service Layer" {
  class FileUploadService {
    +upload_file(request: UploadRequest): UploadResult
    +validate_request(request: UploadRequest): list[str]
    -_prepare_upload_params(request: UploadRequest): dict
    -_handle_upload_result(response: dict, request: UploadRequest): UploadResult
  }

  class ConfigService {
    +get_config(): S3Config
    +set_config_value(key: str, value: str): None
    +test_connection(): bool
    +load_config_from_sources(): S3Config
    -_merge_config_sources(): dict
  }
}

package "Core Layer" {
  interface IS3Client {
    +upload_file(file_path: Path, key: str, bucket: str, **kwargs): dict
    +test_connection(bucket: str): bool
    +list_buckets(): list[str]
  }

  class S3Client {
    +upload_file(file_path: Path, key: str, bucket: str, **kwargs): dict
    +test_connection(bucket: str): bool
    +list_buckets(): list[str]
    -_create_boto3_client(): boto3.client
    -_handle_boto3_exceptions(func): decorator
  }

  class ConfigRepository {
    +load(): dict
    +save(config: dict): None
    +exists(): bool
    -_get_config_path(): Path
    -_validate_config_data(data: dict): bool
  }
}

UploadCommand --> FileUploadService
UploadCommand --> ConfigService
FileUploadService --> IS3Client
ConfigService --> ConfigRepository
S3Client ..|> IS3Client

@enduml
```

## 2. CLI Layer è©³ç´°è¨­è¨ˆ

### 2.1 UploadCommand é¡åˆ¥

```python
from typing import Optional
import typer
from pathlib import Path

class UploadCommand:
    """æª”æ¡ˆä¸Šå‚³ CLI å‘½ä»¤è™•ç†å™¨"""

    def __init__(self, upload_service: FileUploadService, config_service: ConfigService):
        self.upload_service = upload_service
        self.config_service = config_service

    def upload(
        self,
        file_path: str,
        storage_class: str = StorageClass.INTELLIGENT_TIERING.value,
        key: Optional[str] = None,
        show_progress: bool = True
    ) -> None:
        """
        ä¸Šå‚³æª”æ¡ˆåˆ° S3

        Args:
            file_path: è¦ä¸Šå‚³çš„æª”æ¡ˆè·¯å¾‘
            storage_class: S3 å„²å­˜ç­‰ç´š
            key: S3 ä¸­çš„æª”å (å¯é¸)
            show_progress: æ˜¯å¦é¡¯ç¤ºé€²åº¦æ¢
        """
        try:
            # å»ºç«‹ä¸Šå‚³è«‹æ±‚
            request = UploadRequest(
                file_path=Path(file_path),
                key=key,
                storage_class=StorageClass(storage_class)
            )

            # é©—è­‰è«‹æ±‚
            errors = self.upload_service.validate_request(request)
            if errors:
                for error in errors:
                    typer.echo(f"âŒ {error}", err=True)
                raise typer.Exit(1)

            # åŸ·è¡Œä¸Šå‚³
            with typer.progressbar(length=request.file_size, label="ä¸Šå‚³ä¸­...") as progress:
                result = self.upload_service.upload_file(request, progress_callback=progress.update)

            # é¡¯ç¤ºçµæœ
            if result.success:
                typer.echo(f"âœ… æª”æ¡ˆä¸Šå‚³æˆåŠŸ")
                typer.echo(f"   æª”æ¡ˆ: {result.file_path.name}")
                typer.echo(f"   S3 Key: {result.key}")
                typer.echo(f"   Bucket: {result.bucket}")
                typer.echo(f"   Storage Class: {StorageClass.get_display_name(result.storage_class)}")
                typer.echo(f"   æª”æ¡ˆå¤§å°: {self._format_file_size(result.file_size)}")
            else:
                typer.echo(f"âŒ ä¸Šå‚³å¤±æ•—: {result.error_message}", err=True)
                raise typer.Exit(1)

        except StorageClass as e:
            typer.echo(f"âŒ ç„¡æ•ˆçš„å„²å­˜ç­‰ç´š: {storage_class}", err=True)
            self._show_available_storage_classes()
            raise typer.Exit(1)
        except Exception as e:
            typer.echo(f"âŒ ä¸Šå‚³éç¨‹ç™¼ç”ŸéŒ¯èª¤: {str(e)}", err=True)
            raise typer.Exit(1)

    def config_set(self, key: str, value: str) -> None:
        """è¨­å®šé…ç½®å€¼"""
        try:
            self.config_service.set_config_value(key, value)
            typer.echo(f"âœ… é…ç½®å·²æ›´æ–°: {key}")
        except ValueError as e:
            typer.echo(f"âŒ é…ç½®éŒ¯èª¤: {str(e)}", err=True)
            raise typer.Exit(1)

    def config_show(self) -> None:
        """é¡¯ç¤ºç•¶å‰é…ç½®"""
        try:
            config = self.config_service.get_config()
            typer.echo("ğŸ”§ ç•¶å‰ S3 é…ç½®:")
            typer.echo(f"   Access Key ID: {self._mask_sensitive(config.access_key_id)}")
            typer.echo(f"   Secret Access Key: {self._mask_sensitive(config.secret_access_key)}")
            typer.echo(f"   Bucket Name: {config.bucket_name}")
            typer.echo(f"   Region: {config.region}")

            if not config.is_complete():
                typer.echo("âš ï¸  é…ç½®ä¸å®Œæ•´ï¼Œè«‹ä½¿ç”¨ 'config set' å‘½ä»¤è¨­å®šç¼ºå°‘çš„é …ç›®", err=True)
        except Exception as e:
            typer.echo(f"âŒ ç„¡æ³•è¼‰å…¥é…ç½®: {str(e)}", err=True)
            raise typer.Exit(1)

    def config_test(self) -> None:
        """æ¸¬è©¦ S3 é€£æ¥"""
        try:
            typer.echo("ğŸ” æ¸¬è©¦ S3 é€£æ¥...")
            if self.config_service.test_connection():
                typer.echo("âœ… S3 é€£æ¥æ¸¬è©¦æˆåŠŸ")
            else:
                typer.echo("âŒ S3 é€£æ¥æ¸¬è©¦å¤±æ•—", err=True)
                raise typer.Exit(1)
        except Exception as e:
            typer.echo(f"âŒ é€£æ¥æ¸¬è©¦éŒ¯èª¤: {str(e)}", err=True)
            raise typer.Exit(1)

    def _mask_sensitive(self, value: str) -> str:
        """é®ç½©æ•æ„Ÿè³‡è¨Š"""
        if not value or len(value) < 8:
            return "****"
        return f"{value[:4]}****{value[-4:]}"

    def _format_file_size(self, size_bytes: int) -> str:
        """æ ¼å¼åŒ–æª”æ¡ˆå¤§å°"""
        for unit in ['B', 'KB', 'MB', 'GB', 'TB']:
            if size_bytes < 1024.0:
                return f"{size_bytes:.1f} {unit}"
            size_bytes /= 1024.0
        return f"{size_bytes:.1f} PB"

    def _show_available_storage_classes(self) -> None:
        """é¡¯ç¤ºå¯ç”¨çš„å„²å­˜ç­‰ç´š"""
        typer.echo("å¯ç”¨çš„å„²å­˜ç­‰ç´š:")
        for storage_class in StorageClass:
            display_name = StorageClass.get_display_name(storage_class)
            typer.echo(f"  - {storage_class.value}: {display_name}")
```

### 2.2 CLI æ‡‰ç”¨ç¨‹å¼æ•´åˆ

```python
# åœ¨ç¾æœ‰çš„ cli/main.py ä¸­æ·»åŠ æ–°å‘½ä»¤

@app.group()
def upload():
    """æª”æ¡ˆä¸Šå‚³ç›¸é—œå‘½ä»¤"""
    pass

@app.group()
def config():
    """é…ç½®ç®¡ç†ç›¸é—œå‘½ä»¤"""
    pass

# ä¾è³´æ³¨å…¥è¨­å®š
def get_upload_command() -> UploadCommand:
    """å–å¾—ä¸Šå‚³å‘½ä»¤è™•ç†å™¨"""
    config_repo = ConfigRepository()
    s3_client = S3Client()
    config_service = ConfigService(config_repo)
    upload_service = FileUploadService(s3_client, config_service)
    return UploadCommand(upload_service, config_service)

@upload.command("file")
def upload_file(
    file_path: str = typer.Argument(..., help="è¦ä¸Šå‚³çš„æª”æ¡ˆè·¯å¾‘"),
    storage_class: str = typer.Option(
        StorageClass.INTELLIGENT_TIERING.value,
        "--storage-class", "-s",
        help="S3 å„²å­˜ç­‰ç´š"
    ),
    key: Optional[str] = typer.Option(None, "--key", "-k", help="S3 ä¸­çš„æª”å"),
) -> None:
    """ä¸Šå‚³æª”æ¡ˆåˆ° S3"""
    upload_cmd = get_upload_command()
    upload_cmd.upload(file_path, storage_class, key)

@config.command("set")
def config_set(
    key: str = typer.Argument(..., help="é…ç½®é …ç›®åç¨±"),
    value: str = typer.Argument(..., help="é…ç½®å€¼"),
) -> None:
    """è¨­å®šé…ç½®å€¼"""
    upload_cmd = get_upload_command()
    upload_cmd.config_set(key, value)

@config.command("show")
def config_show() -> None:
    """é¡¯ç¤ºç•¶å‰é…ç½®"""
    upload_cmd = get_upload_command()
    upload_cmd.config_show()

@config.command("test")
def config_test() -> None:
    """æ¸¬è©¦ S3 é€£æ¥"""
    upload_cmd = get_upload_command()
    upload_cmd.config_test()
```

## 3. Service Layer è©³ç´°è¨­è¨ˆ

### 3.1 FileUploadService é¡åˆ¥

```python
from typing import Optional, Callable
import mimetypes
from pathlib import Path

class FileUploadService:
    """æª”æ¡ˆä¸Šå‚³æœå‹™"""

    def __init__(self, s3_client: IS3Client, config_service: ConfigService):
        self.s3_client = s3_client
        self.config_service = config_service

    def upload_file(
        self,
        request: UploadRequest,
        progress_callback: Optional[Callable[[int], None]] = None
    ) -> UploadResult:
        """
        ä¸Šå‚³æª”æ¡ˆåˆ° S3

        Args:
            request: ä¸Šå‚³è«‹æ±‚
            progress_callback: é€²åº¦å›èª¿å‡½æ•¸

        Returns:
            ä¸Šå‚³çµæœ
        """
        try:
            # é©—è­‰è«‹æ±‚
            errors = self.validate_request(request)
            if errors:
                raise ValueError(f"è«‹æ±‚é©—è­‰å¤±æ•—: {'; '.join(errors)}")

            # è¼‰å…¥é…ç½®
            config = self.config_service.get_config()
            if not config.is_complete():
                raise ValueError("S3 é…ç½®ä¸å®Œæ•´")

            # æº–å‚™ä¸Šå‚³åƒæ•¸
            upload_params = self._prepare_upload_params(request)

            # åŸ·è¡Œä¸Šå‚³
            response = self.s3_client.upload_file(
                file_path=request.file_path,
                key=request.key,
                bucket=config.bucket_name,
                progress_callback=progress_callback,
                **upload_params
            )

            # è™•ç†çµæœ
            return self._handle_upload_result(response, request, config)

        except Exception as e:
            return UploadResult.error_result(
                key=request.key,
                bucket=config.bucket_name if config else "unknown",
                file_path=request.file_path,
                file_size=request.file_size,
                storage_class=request.storage_class,
                error_message=str(e),
                error_code=self._get_error_code(e)
            )

    def validate_request(self, request: UploadRequest) -> list[str]:
        """é©—è­‰ä¸Šå‚³è«‹æ±‚"""
        errors = request.validate()

        # é¡å¤–çš„æ¥­å‹™é‚è¼¯é©—è­‰
        if request.file_size > 5 * 1024 * 1024 * 1024 * 1024:  # 5TB
            errors.append("æª”æ¡ˆå¤§å°è¶…é S3 é™åˆ¶ (5TB)")

        return errors

    def _prepare_upload_params(self, request: UploadRequest) -> dict:
        """æº–å‚™ä¸Šå‚³åƒæ•¸"""
        params = {
            'StorageClass': request.storage_class.value
        }

        # è‡ªå‹•åµæ¸¬ Content Type
        if request.content_type is None:
            content_type, _ = mimetypes.guess_type(str(request.file_path))
            if content_type:
                params['ContentType'] = content_type
        else:
            params['ContentType'] = request.content_type

        # æ·»åŠ  Metadata
        if request.metadata:
            params['Metadata'] = request.metadata

        return params

    def _handle_upload_result(
        self,
        response: dict,
        request: UploadRequest,
        config: S3Config
    ) -> UploadResult:
        """è™•ç†ä¸Šå‚³çµæœ"""
        return UploadResult.success_result(
            key=request.key,
            bucket=config.bucket_name,
            file_path=request.file_path,
            file_size=request.file_size,
            storage_class=request.storage_class,
            etag=response.get('ETag'),
            version_id=response.get('VersionId')
        )

    def _get_error_code(self, exception: Exception) -> Optional[str]:
        """å–å¾—éŒ¯èª¤ä»£ç¢¼"""
        if isinstance(exception, FileNotFoundError):
            return ErrorCode.FILE_NOT_FOUND.value
        elif isinstance(exception, PermissionError):
            return ErrorCode.FILE_NOT_READABLE.value
        # æ›´å¤šéŒ¯èª¤ç¢¼å°æ‡‰...
        return ErrorCode.UNKNOWN_ERROR.value
```

### 3.2 ConfigService é¡åˆ¥

```python
import os
from typing import Dict, Any

class ConfigService:
    """é…ç½®ç®¡ç†æœå‹™"""

    def __init__(self, config_repository: ConfigRepository):
        self.config_repository = config_repository
        self._config_cache: Optional[S3Config] = None

    def get_config(self) -> S3Config:
        """å–å¾— S3 é…ç½®"""
        if self._config_cache is None:
            self._config_cache = self.load_config_from_sources()
        return self._config_cache

    def set_config_value(self, key: str, value: str) -> None:
        """è¨­å®šé…ç½®å€¼"""
        # é©—è­‰é…ç½®éµå€¼
        valid_keys = {
            'aws-access-key-id': 'access_key_id',
            'aws-secret-access-key': 'secret_access_key',
            'bucket-name': 'bucket_name',
            'region': 'region'
        }

        if key not in valid_keys:
            raise ValueError(f"ç„¡æ•ˆçš„é…ç½®é …ç›®: {key}")

        # è¼‰å…¥ç¾æœ‰é…ç½®
        current_config = self.config_repository.load()

        # æ›´æ–°é…ç½®
        current_config[valid_keys[key]] = value

        # å„²å­˜é…ç½®
        self.config_repository.save(current_config)

        # æ¸…é™¤å¿«å–
        self._config_cache = None

    def test_connection(self) -> bool:
        """æ¸¬è©¦ S3 é€£æ¥"""
        try:
            config = self.get_config()
            if not config.is_complete():
                return False

            # é€™è£¡éœ€è¦ S3Client å¯¦ä¾‹ä¾†æ¸¬è©¦é€£æ¥
            # ç‚ºäº†é¿å…å¾ªç’°ä¾è³´ï¼Œå¯ä»¥åœ¨åˆå§‹åŒ–æ™‚æ³¨å…¥
            s3_client = S3Client()
            s3_client.configure(config)
            return s3_client.test_connection(config.bucket_name)

        except Exception:
            return False

    def load_config_from_sources(self) -> S3Config:
        """å¾å„ç¨®ä¾†æºè¼‰å…¥é…ç½®"""
        config_data = self._merge_config_sources()

        return S3Config(
            access_key_id=config_data.get('access_key_id', ''),
            secret_access_key=config_data.get('secret_access_key', ''),
            bucket_name=config_data.get('bucket_name', ''),
            region=config_data.get('region', 'us-east-1')
        )

    def _merge_config_sources(self) -> Dict[str, Any]:
        """åˆä½µå„ç¨®é…ç½®ä¾†æº"""
        config = {}

        # 1. é è¨­å€¼
        defaults = {
            'region': 'us-east-1'
        }
        config.update(defaults)

        # 2. é…ç½®æª”æ¡ˆ
        try:
            file_config = self.config_repository.load()
            config.update(file_config)
        except Exception:
            pass  # é…ç½®æª”æ¡ˆä¸å­˜åœ¨æˆ–æå£

        # 3. ç’°å¢ƒè®Šæ•¸
        env_mapping = {
            'AWS_ACCESS_KEY_ID': 'access_key_id',
            'AWS_SECRET_ACCESS_KEY': 'secret_access_key',
            'AWS_DEFAULT_REGION': 'region',
            'S3_BUCKET_NAME': 'bucket_name'
        }

        for env_key, config_key in env_mapping.items():
            env_value = os.getenv(env_key)
            if env_value:
                config[config_key] = env_value

        return config
```

## 4. Core Layer è©³ç´°è¨­è¨ˆ

### 4.1 IS3Client ä»‹é¢

```python
from abc import ABC, abstractmethod
from typing import Dict, Any, List, Optional, Callable
from pathlib import Path

class IS3Client(ABC):
    """S3 å®¢æˆ¶ç«¯ä»‹é¢"""

    @abstractmethod
    def configure(self, config: S3Config) -> None:
        """é…ç½® S3 å®¢æˆ¶ç«¯"""
        pass

    @abstractmethod
    def upload_file(
        self,
        file_path: Path,
        key: str,
        bucket: str,
        progress_callback: Optional[Callable[[int], None]] = None,
        **kwargs
    ) -> Dict[str, Any]:
        """ä¸Šå‚³æª”æ¡ˆåˆ° S3"""
        pass

    @abstractmethod
    def test_connection(self, bucket: str) -> bool:
        """æ¸¬è©¦ S3 é€£æ¥"""
        pass

    @abstractmethod
    def list_buckets(self) -> List[str]:
        """åˆ—å‡ºæ‰€æœ‰ buckets"""
        pass
```

### 4.2 S3Client å¯¦ä½œ

```python
import boto3
from botocore.exceptions import ClientError, NoCredentialsError
from functools import wraps
from typing import Dict, Any, List, Optional, Callable

class S3Client(IS3Client):
    """S3 å®¢æˆ¶ç«¯å¯¦ä½œ"""

    def __init__(self):
        self._client: Optional[boto3.client] = None
        self._config: Optional[S3Config] = None

    def configure(self, config: S3Config) -> None:
        """é…ç½® S3 å®¢æˆ¶ç«¯"""
        self._config = config
        self._client = self._create_boto3_client()

    @_handle_boto3_exceptions
    def upload_file(
        self,
        file_path: Path,
        key: str,
        bucket: str,
        progress_callback: Optional[Callable[[int], None]] = None,
        **kwargs
    ) -> Dict[str, Any]:
        """ä¸Šå‚³æª”æ¡ˆåˆ° S3"""
        if not self._client:
            raise ValueError("S3 å®¢æˆ¶ç«¯æœªé…ç½®")

        # æº–å‚™ä¸Šå‚³åƒæ•¸
        extra_args = {k: v for k, v in kwargs.items() if v is not None}

        # å¦‚æœæœ‰é€²åº¦å›èª¿ï¼Œä½¿ç”¨ upload_fileï¼Œå¦å‰‡ä½¿ç”¨ put_object
        if progress_callback:
            self._client.upload_file(
                str(file_path),
                bucket,
                key,
                ExtraArgs=extra_args,
                Callback=progress_callback
            )
            # upload_file ä¸è¿”å› responseï¼Œéœ€è¦ç”¨ head_object å–å¾—è³‡è¨Š
            response = self._client.head_object(Bucket=bucket, Key=key)
        else:
            with open(file_path, 'rb') as file_obj:
                response = self._client.put_object(
                    Bucket=bucket,
                    Key=key,
                    Body=file_obj,
                    **extra_args
                )

        return response

    @_handle_boto3_exceptions
    def test_connection(self, bucket: str) -> bool:
        """æ¸¬è©¦ S3 é€£æ¥"""
        if not self._client:
            return False

        try:
            self._client.head_bucket(Bucket=bucket)
            return True
        except ClientError as e:
            error_code = e.response['Error']['Code']
            if error_code == '404':
                # Bucket ä¸å­˜åœ¨
                return False
            elif error_code == '403':
                # æ²’æœ‰æ¬Šé™ä½†å¯ä»¥é€£æ¥
                return True
            else:
                return False

    @_handle_boto3_exceptions
    def list_buckets(self) -> List[str]:
        """åˆ—å‡ºæ‰€æœ‰ buckets"""
        if not self._client:
            raise ValueError("S3 å®¢æˆ¶ç«¯æœªé…ç½®")

        response = self._client.list_buckets()
        return [bucket['Name'] for bucket in response['Buckets']]

    def _create_boto3_client(self) -> boto3.client:
        """å»ºç«‹ boto3 å®¢æˆ¶ç«¯"""
        if not self._config:
            raise ValueError("é…ç½®æœªè¨­å®š")

        boto3_config = self._config.to_boto3_config()
        return boto3.client('s3', **boto3_config)

    @staticmethod
    def _handle_boto3_exceptions(func):
        """è™•ç† boto3 ç•°å¸¸çš„è£é£¾å™¨"""
        @wraps(func)
        def wrapper(*args, **kwargs):
            try:
                return func(*args, **kwargs)
            except NoCredentialsError as e:
                raise CloudStorageError(
                    code=ErrorCode.AWS_AUTH_ERROR,
                    message="AWS èªè­‰å¤±æ•—",
                    details="è«‹æª¢æŸ¥ Access Key å’Œ Secret Key",
                    original_exception=e
                )
            except ClientError as e:
                error_code = e.response['Error']['Code']
                error_message = e.response['Error']['Message']

                if error_code == 'NoSuchBucket':
                    raise CloudStorageError(
                        code=ErrorCode.S3_BUCKET_NOT_FOUND,
                        message=f"S3 Bucket ä¸å­˜åœ¨: {error_message}",
                        original_exception=e
                    )
                elif error_code == 'AccessDenied':
                    raise CloudStorageError(
                        code=ErrorCode.S3_PERMISSION_DENIED,
                        message=f"S3 æ¬Šé™ä¸è¶³: {error_message}",
                        original_exception=e
                    )
                else:
                    raise CloudStorageError(
                        code=ErrorCode.UNKNOWN_ERROR,
                        message=f"S3 æ“ä½œå¤±æ•—: {error_message}",
                        details=f"éŒ¯èª¤ä»£ç¢¼: {error_code}",
                        original_exception=e
                    )
            except Exception as e:
                raise CloudStorageError(
                    code=ErrorCode.UNKNOWN_ERROR,
                    message="æœªçŸ¥éŒ¯èª¤",
                    details=str(e),
                    original_exception=e
                )
        return wrapper
```

### 4.3 ConfigRepository é¡åˆ¥

```python
import json
from pathlib import Path
from typing import Dict, Any

class ConfigRepository:
    """é…ç½®å­˜å„²åº«"""

    def __init__(self, config_dir: Optional[Path] = None):
        self.config_dir = config_dir or Path.home() / '.cloud-storage-syncer'
        self.config_file = self.config_dir / 'config.json'

    def load(self) -> Dict[str, Any]:
        """è¼‰å…¥é…ç½®"""
        if not self.exists():
            return {}

        try:
            with open(self.config_file, 'r', encoding='utf-8') as f:
                data = json.load(f)
                if self._validate_config_data(data):
                    return data
                else:
                    return {}
        except (json.JSONDecodeError, IOError):
            return {}

    def save(self, config: Dict[str, Any]) -> None:
        """å„²å­˜é…ç½®"""
        # ç¢ºä¿é…ç½®ç›®éŒ„å­˜åœ¨
        self.config_dir.mkdir(parents=True, exist_ok=True)

        # é©—è­‰é…ç½®è³‡æ–™
        if not self._validate_config_data(config):
            raise ValueError("é…ç½®è³‡æ–™æ ¼å¼ç„¡æ•ˆ")

        # å„²å­˜åˆ°æª”æ¡ˆ
        with open(self.config_file, 'w', encoding='utf-8') as f:
            json.dump(config, f, indent=2, ensure_ascii=False)

        # è¨­å®šæª”æ¡ˆæ¬Šé™ (åªæœ‰æ“æœ‰è€…å¯è®€å¯«)
        self.config_file.chmod(0o600)

    def exists(self) -> bool:
        """æª¢æŸ¥é…ç½®æª”æ¡ˆæ˜¯å¦å­˜åœ¨"""
        return self.config_file.exists()

    def _get_config_path(self) -> Path:
        """å–å¾—é…ç½®æª”æ¡ˆè·¯å¾‘"""
        return self.config_file

    def _validate_config_data(self, data: Dict[str, Any]) -> bool:
        """é©—è­‰é…ç½®è³‡æ–™æ ¼å¼"""
        if not isinstance(data, dict):
            return False

        # æª¢æŸ¥å¿…è¦æ¬„ä½é¡å‹
        string_fields = ['access_key_id', 'secret_access_key', 'bucket_name', 'region']
        for field in string_fields:
            if field in data and not isinstance(data[field], str):
                return False

        return True
```

## 5. ä¾è³´æ³¨å…¥èˆ‡çµ„è£

```python
# di.py - ä¾è³´æ³¨å…¥é…ç½®

class DIContainer:
    """ä¾è³´æ³¨å…¥å®¹å™¨"""

    def __init__(self):
        self._instances = {}

    def get_config_repository(self) -> ConfigRepository:
        """å–å¾—é…ç½®å­˜å„²åº«"""
        if 'config_repository' not in self._instances:
            self._instances['config_repository'] = ConfigRepository()
        return self._instances['config_repository']

    def get_s3_client(self) -> IS3Client:
        """å–å¾— S3 å®¢æˆ¶ç«¯"""
        if 's3_client' not in self._instances:
            self._instances['s3_client'] = S3Client()
        return self._instances['s3_client']

    def get_config_service(self) -> ConfigService:
        """å–å¾—é…ç½®æœå‹™"""
        if 'config_service' not in self._instances:
            config_repo = self.get_config_repository()
            self._instances['config_service'] = ConfigService(config_repo)
        return self._instances['config_service']

    def get_upload_service(self) -> FileUploadService:
        """å–å¾—ä¸Šå‚³æœå‹™"""
        if 'upload_service' not in self._instances:
            s3_client = self.get_s3_client()
            config_service = self.get_config_service()

            # é…ç½® S3 å®¢æˆ¶ç«¯
            config = config_service.get_config()
            if config.is_complete():
                s3_client.configure(config)

            self._instances['upload_service'] = FileUploadService(s3_client, config_service)
        return self._instances['upload_service']

    def get_upload_command(self) -> UploadCommand:
        """å–å¾—ä¸Šå‚³å‘½ä»¤è™•ç†å™¨"""
        if 'upload_command' not in self._instances:
            upload_service = self.get_upload_service()
            config_service = self.get_config_service()
            self._instances['upload_command'] = UploadCommand(upload_service, config_service)
        return self._instances['upload_command']

# å…¨åŸŸå®¹å™¨å¯¦ä¾‹
container = DIContainer()
```

é€™å€‹è¨­è¨ˆéµå¾ªäº† SOLID åŸå‰‡ï¼š
- **S**: æ¯å€‹é¡åˆ¥éƒ½æœ‰å–®ä¸€è·è²¬
- **O**: ä½¿ç”¨ä»‹é¢è¨­è¨ˆï¼Œæ˜“æ–¼æ“´å±•
- **L**: å¯¦ä½œé¡åˆ¥å¯ä»¥æ›¿æ›ä»‹é¢
- **I**: ä»‹é¢åˆ†é›¢ï¼Œä¸åŒå±¤ç´šæœ‰ä¸åŒä»‹é¢
- **D**: ä¾è³´æŠ½è±¡è€Œéå…·é«”å¯¦ä½œ

è¨­è¨ˆç‰¹è‰²ï¼š
- **ä¸‰å±¤æ¶æ§‹**: æ¸…æ™°çš„è²¬ä»»åˆ†é›¢
- **ä»‹é¢é©…å‹•**: æ˜“æ–¼æ¸¬è©¦å’Œæ“´å±•
- **éŒ¯èª¤è™•ç†**: å®Œæ•´çš„ç•°å¸¸è™•ç†æ©Ÿåˆ¶
- **é…ç½®ç®¡ç†**: å¤šä¾†æºé…ç½®åˆä½µ
- **é€²åº¦é¡¯ç¤º**: æ”¯æ´æª”æ¡ˆä¸Šå‚³é€²åº¦
