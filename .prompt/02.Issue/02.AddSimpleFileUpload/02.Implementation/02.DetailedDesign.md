# 詳細設計

## 1. 設計概述

基於基本設計和技術可行性驗證結果，本文件提供檔案上傳功能的詳細設計規格。

## 2. 專案結構設計

### 2.1 目錄結構

```
src/cloud_storage_syncer/
├── __init__.py                 # 套件初始化
├── main.py                     # CLI 入口點
├── models/                     # 資料模型
│   ├── __init__.py
│   ├── config.py              # S3Config
│   ├── storage.py             # S3StorageClass
│   └── upload.py              # UploadRequest, UploadResult
├── services/                   # 業務邏輯服務
│   ├── __init__.py
│   └── s3_service.py          # S3Service
└── cli/                       # CLI 命令介面
    ├── __init__.py
    ├── upload.py              # upload 命令
    └── config.py              # config 命令群組
```

### 2.2 模組依賴關係

```plantuml
@startuml
!theme plain

package "CLI Layer" {
    [cli.upload] --> [services.s3_service]
    [cli.config] --> [services.s3_service]
}

package "Service Layer" {
    [services.s3_service] --> [models.config]
    [services.s3_service] --> [models.upload]
    [services.s3_service] --> [models.storage]
}

package "Model Layer" {
    [models.config]
    [models.upload]
    [models.storage]
}

package "External Dependencies" {
    [boto3]
    [typer]
}

[services.s3_service] --> [boto3]
[cli.upload] --> [typer]
[cli.config] --> [typer]

@enduml
```

## 3. 資料模型詳細設計

### 3.1 檔案位置與責任

| 檔案 | 類別/枚舉 | 責任 |
|------|-----------|------|
| `models/config.py` | `S3Config` | S3 配置資料結構 |
| `models/storage.py` | `S3StorageClass` | S3 儲存等級枚舉 |
| `models/upload.py` | `UploadRequest`, `UploadResult` | 上傳請求與結果 DTO |

### 3.2 模型間的關係

```plantuml
@startuml
!theme plain

class S3Config {
    +access_key: str
    +secret_key: str
    +bucket: str
    +region: str
    +is_valid(): bool
}

enum S3StorageClass {
    STANDARD
    INTELLIGENT_TIERING
    STANDARD_IA
    ONEZONE_IA
    GLACIER_IR
    GLACIER
    DEEP_ARCHIVE
}

class UploadRequest {
    +file_path: str
    +s3_key: str
    +storage_class: S3StorageClass
}

class UploadResult {
    +success: bool
    +error_message: str
    +success_result(): UploadResult
    +error_result(msg): UploadResult
}

UploadRequest --> S3StorageClass

@enduml
```

## 4. 服務層詳細設計

### 4.1 S3Service 類別設計

**檔案位置**: `src/cloud_storage_syncer/services/s3_service.py`

**主要責任**:
- S3 檔案上傳操作
- S3 連接測試
- 配置檔案管理
- boto3 客戶端管理

**方法簽名**:
```python
class S3Service:
    def __init__(self) -> None
    def upload(self, request: UploadRequest) -> UploadResult
    def test_connection(self) -> bool
    def load_config(self) -> S3Config
    def save_config(self, config: S3Config) -> None
    def _init_s3_client(self, config: S3Config) -> None
```

### 4.2 配置檔案管理設計

**配置檔案路徑**: `~/.cloud-storage-syncer/config.json`

**檔案格式**:
```json
{
  "access_key": "AKIAXXXXXXXXXXXXXXXX",
  "secret_key": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
  "bucket": "my-bucket-name",
  "region": "us-east-1"
}
```

**檔案權限**: 0600 (僅擁有者可讀寫)

## 5. CLI 層詳細設計

### 5.1 主要入口設計

**檔案位置**: `src/cloud_storage_syncer/main.py`

**功能**:
- 初始化 Typer 應用
- 註冊命令群組
- 提供應用入口點

### 5.2 命令設計

#### 5.2.1 upload 命令

**檔案位置**: `src/cloud_storage_syncer/cli/upload.py`

**命令格式**:
```bash
cloud-storage-syncer upload <file_path> [OPTIONS]
```

**參數設計**:
- `file_path` (required): 要上傳的檔案路徑
- `--storage-class` (optional): S3 儲存等級，預設 "INTELLIGENT_TIERING"
- `--key` (optional): S3 中的檔案名稱，預設使用原檔案名

#### 5.2.2 config 命令群組

**檔案位置**: `src/cloud_storage_syncer/cli/config.py`

**子命令**:
1. `config set <key> <value>` - 設定配置項目
2. `config show` - 顯示當前配置（敏感資訊遮罩）
3. `config test` - 測試 S3 連接

## 6. 錯誤處理設計

### 6.1 錯誤類型分類

| 錯誤類型 | 處理層級 | 處理方式 |
|----------|----------|----------|
| 檔案不存在 | Service | 返回 UploadResult.error |
| 配置不完整 | Service | 返回 UploadResult.error |
| S3 權限錯誤 | Service | 捕獲 boto3 異常，返回錯誤 |
| 網路連接錯誤 | Service | 捕獲異常，返回錯誤 |
| 無效參數 | CLI | Typer 自動處理 + 自定義驗證 |

### 6.2 錯誤訊息設計

**成功訊息**:
- `✅ 檔案已成功上傳到 s3://bucket-name/file-key`
- `✅ S3 連接測試成功`
- `✅ 配置已更新: access-key`

**錯誤訊息**:
- `❌ 檔案不存在: /path/to/file`
- `❌ S3 配置不完整，請先設定配置`
- `❌ S3 連接測試失敗`
- `❌ 無效的配置項目: invalid-key`

## 7. 實作優先順序

### 7.1 第一階段：核心功能
1. 建立專案結構和模型類別
2. 實作 S3Service 基本功能
3. 實作 upload 命令

### 7.2 第二階段：配置管理
1. 實作配置檔案讀寫
2. 實作 config 命令群組
3. 完善錯誤處理

### 7.3 第三階段：完善與測試
1. 整合測試
2. 錯誤處理完善
3. 使用者體驗優化

## 8. 技術決策記錄

### 8.1 已確認的技術選型
- ✅ Python 3.13
- ✅ boto3 (1.40.2) for AWS S3 SDK
- ✅ typer (0.16.0) for CLI framework
- ✅ uv for package management
- ✅ JSON for configuration file format

### 8.2 設計原則
- **簡單優先**: 避免過度工程化
- **責任分離**: 清楚的層級劃分
- **錯誤友好**: 提供清楚的錯誤訊息
- **測試友好**: 便於單元測試的設計
